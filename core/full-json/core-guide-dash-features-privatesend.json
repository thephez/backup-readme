{
 "metadata": {
  "image": [],
  "title": "Dash Core CoinJoin",
  "description": "Dash Core's mixing feature provides a way to improve privacy by performing non-custodial CoinJoin.",
  "keywords": "",
  "robots": "index"
 },
 "api": {
  "method": "get",
  "url": "",
  "auth": "required",
  "results": {
   "codes": [
    {
     "status": 200,
     "language": "json",
     "code": "{}",
     "name": ""
    },
    {
     "status": 400,
     "language": "json",
     "code": "{}",
     "name": ""
    }
   ]
  },
  "params": []
 },
 "next": {
  "description": "",
  "pages": [
   {
    "type": "doc",
    "icon": "file-text-o",
    "name": "Masternode Payment",
    "slug": "core-guide-dash-features-masternode-payment",
    "category": "Core Guides"
   }
  ]
 },
 "algolia": {
  "recordCount": 4,
  "publishPending": false,
  "translationFailure": false,
  "updatedAt": "2023-04-25T20:01:05.557Z"
 },
 "title": "CoinJoin",
 "icon": "",
 "updates": [],
 "type": "basic",
 "slug": "core-guide-dash-features-privatesend",
 "excerpt": "",
 "body": "Dash Core's mixing feature provides a way to improve privacy by performing non-custodial CoinJoin. For additional details, reference this [Official Documentation page](https://docs.dash.org/en/stable/introduction/features.html#coinjoin).\n\nThe following video provides an overview with a good introduction to the details:\n\n<iframe width=\"500\" height=\"375\" src=\"https://www.youtube-nocookie.com/embed/vgCId3wJc5Y?rel=0\"></iframe>\n\n\n[block:embed]\n{\n  \"html\": false,\n  \"url\": \"https://www.youtube-nocookie.com/embed/vgCId3wJc5Y?rel=0\",\n  \"title\": \"How Dash's 'PrivateSend' Works Under the Hood\",\n  \"favicon\": \"https://www.youtube-nocookie.com/favicon.ico\",\n  \"provider\": \"youtube-nocookie.com\",\n  \"href\": \"https://www.youtube-nocookie.com/embed/vgCId3wJc5Y?rel=0\",\n  \"height\": \"350px\",\n  \"width\": \"100%\",\n  \"iframe\": true\n}\n[/block]\n\n\n\n\n# Wallet Preparation\n\nThe <<glossary:wallet>> completes two operations in this phase:\n\n1. Split value into inputs matching the CoinJoin <<glossary:denominations>> by sending <<glossary:transactions>> to itself\n\n2. Split value into <<glossary:inputs>> to use for collateral by sending transactions to itself\n\n**Note**: Both these operations incur the standard <<glossary:transaction fee>> like any other transaction\n\n**Creating Denominations**\n\nThe CoinJoin denominations include a bit mapping to easily differentiate them. The [`dsa` message](core-ref-p2p-network-privatesend-messages#dsa) and [`dsq` message](core-ref-p2p-network-privatesend-messages#dsq) use this bit shifted integer instead of sending the actual denomination. The table below lists the bit, its associated integer value used in P2P messages, and the actual Dash value.\n\n| **Bit** | **Denom. (Integer)** | **Denomination (DASH)** |\n| ------- | -------------------- | ----------------------- |\n| 0       | 1                    | 10.0001                 |\n| 1       | 2                    | 01.00001                |\n| 2       | 4                    | 00.100001               |\n| 3       | 8                    | 00.0100001              |\n| 4       | 16                   | 00.00100001             |\n\nProtocol version 70213 added a 5th denomination (0.001 DASH).\n\n[Example Testnet denomination creation transaction](https://testnet-insight.dashevo.org/insight/tx/f0174fc87d68a18617c2990df4d9455c0459c601d2d6473934357a66f9b8b70a)\n\n**Creating Collaterals**\n\nCollaterals are used to pay CoinJoin fees, but are kept separate from the denominations to maximize privacy. Since protocol version 70213, the minimum collateral fee is 1/10 of the smallest denomination for all sessions regardless of denomination. In Dash Core, collaterals are created with enough value to pay 4 collateral fees (4 x 0.001 DASH). ([Dash Core Reference](https://github.com/dashpay/dash/blob/v0.15.0.0/src/privatesend/privatesend.h#L459))\n\nIn protocol version 70208, collateral inputs can be anything from 2x the minimum collateral amount to the maximum collateral amount (currently defined as 4x the minimum collateral). In protocol versions > 70208, Dash Core can use any <<glossary:input>> from 1x the minimum collateral amount to the maximum collateral amount.\n\n[Example Testnet collateral creation transaction](https://testnet-insight.dashevo.org/insight/tx/8f9b15973983876f7ce4eb2c32b09690dfb0432d2caf6c6df516196a8d17689f)\n\n[Example Testnet collateral payment transaction](https://testnet-insight.dashevo.org/insight/tx/de51e6f7c5ef75aad0dbb0a808ef4873d7ef6d67b25f3a658d5a241db4f3eeeb)\n\n# CoinJoin Processing\n\nThis phase involves exchanging a sequence of messages with a <<glossary:masternode>> so it can construct a denominate transaction with inputs from the clients in its pool.\n\n_Data Flow_\n\n|    | **Clients**                                                            | **Direction** | **Masternode**                                                   | **Description**                                                                                                                                                                                                                                     |\n| -- | ---------------------------------------------------------------------- | :-----------: | ---------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| 0  |                                                                        |               |                                                                  | Client determines whether to join an existing pool or create a new one                                                                                                                                                                              |\n| 1  | [`dsa` message](core-ref-p2p-network-privatesend-messages#dsa)         |       \u2192       |                                                                  | Client asks to join pool or have the masternode create a new one                                                                                                                                                                                    |\n| 2  |                                                                        |       \u2190       | [`dssu` message](core-ref-p2p-network-privatesend-messages#dssu) | Masternode provides a pool status update (Typical - State: `POOL_STATE_QUEUE`, Message: `MSG_NOERR`)                                                                                                                                                |\n| 3  |                                                                        |       \u2190       | [`dsq` message](core-ref-p2p-network-privatesend-messages#dsq)   | Masternode notifies clients when it is ready to receive inputs                                                                                                                                                                                      |\n| 4  | [`dsi` message](core-ref-p2p-network-privatesend-messages#dsi)         |       \u2192       |                                                                  | Upon receiving a [`dsq` message](core-ref-p2p-network-privatesend-messages#dsq) with the Ready bit set, clients each provide a list of their inputs (unsigned), collateral, and a list of outputs where funds should be sent                        |\n| 5  |                                                                        |       \u2190       | [`dssu` message](core-ref-p2p-network-privatesend-messages#dssu) | Masternode provides a pool status update (typical - State: `POOL_STATE_ACCEPTING_ENTRIES`, Message: `MSG_ENTRIES_ADDED`)                                                                                                                            |\n| 6  |                                                                        |       \u2190       | [`dsf` message](core-ref-p2p-network-privatesend-messages#dsf)   | Masternode sends the final transaction containing all clients inputs (unsigned) and all client outputs to each client for verification                                                                                                              |\n| 7  |                                                                        |       \u2190       | [`dssu` message](core-ref-p2p-network-privatesend-messages#dssu) | Masternode provides a pool status update (Typical - State: `POOL_STATE_SIGNING`, Message: `MSG_NOERR`)                                                                                                                                              |\n| 8  | [`dss` message](core-ref-p2p-network-privatesend-messages#dss)         |       \u2192       |                                                                  | After verifying the final transaction, clients each sign their own inputs and send them back                                                                                                                                                        |\n| 9  |                                                                        |       \u2190       | [`dsc` message](core-ref-p2p-network-privatesend-messages#dsc)   | Masternode verifies the signed inputs, creates a [`dstx` message](core-ref-p2p-network-privatesend-messages#dstx) to broadcast the transaction, and notifies clients that the denominate transaction is complete (Typical - Message: `MSG_SUCCESS`) |\n| 10 |                                                                        |       \u2190       | [`inv` message](core-ref-p2p-network-data-messages#inv)          | Masternode broadcasts a `dstx` inventory message                                                                                                                                                                                                    |\n| 11 | [`getdata` message](core-ref-p2p-network-data-messages#getdata) (dstx) |       \u2192       |                                                                  | (Optional)                                                                                                                                                                                                                                          |\n\n**Additional notes**\n\n_**Step 0 - Pool Selection**_\n\n- Existing pool information is derived from the Queue messages seen by the client\n- Dash Core attempts to join an existing pool and only requests creation of a new one if that fails, although this is not a requirement that alternative implementations would be required to follow\n\n_**Step 1 - Pool Request**_\n\n- The [`dsa` message](core-ref-p2p-network-privatesend-messages#dsa) contains a collateral transaction\n  - This transaction uses a collateral <<glossary:input>> created in the [Wallet Preparation](#wallet-preparation) phase\n  - The collateral is a signed <<glossary:transaction>> that pays the collateral back to a client <<glossary:address>> minus a fee of 0.001 DASH\n\n_**Step 3 - Queue**_\n\n- A masternode broadcasts [`dsq` messages](core-ref-p2p-network-privatesend-messages#dsq) when it starts a new queue. These message are relayed by all <<glossary:peers>>.\n- As of protocol version 70214, sessions have a variable number of participants defined by the range `nPoolMinParticipants` ([3](https://github.com/dashpay/dash/blob/v0.15.0.0/src/chainparams.cpp#L360)) to `nPoolMaxParticipants` ([5](https://github.com/dashpay/dash/blob/v0.15.0.0/src/chainparams.cpp#L361)). Prior protocol version sessions always contained exactly 3 participants. Spork 22 introduced in Dash Core 0.16.0 expanded the maximum number of participants to 20 and also reduced the minimum number of participants to 2 for testnet/devnet/regtest networks. The spork was removed in Dash Core 0.17.0 which made the change permanent.\n- The masternode sends a [`dsq` message](core-ref-p2p-network-privatesend-messages#dsq) with the ready bit set once it has received valid [`dsa` messages](core-ref-p2p-network-privatesend-messages#dsa) from either:\n  1. The maximum number of clients (20)\n  2. Greater than the minimum number of clients (3) and the timeout has been reached ([30 seconds](https://github.com/dashpay/dash/blob/v0.16.x/src/privatesend/privatesend.h#L23))\n\n> \ud83d\udea7 \n> \n> Clients must respond to the Queue ready within 30 seconds or risk forfeiting the collateral they provided in the [`dsa` message](core-ref-p2p-network-privatesend-messages#dsa) (Step 1) ([Dash Core Reference](https://github.com/dashpay/dash/blob/v0.16.x/src/privatesend/privatesend.h#L23))\n\n_**Step 4 - Inputs**_\n\n- The collateral transaction can be the same in the [`dsi` message](core-ref-p2p-network-privatesend-messages#dsi) as the one in the [`dsa` message](core-ref-p2p-network-privatesend-messages#dsa) (Step 1) as long as it has not been spent\n- Each client can provide up to 9 (`COINJOIN_ENTRY_MAX_SIZE`) inputs (and an equal number of outputs) to be used ([Dash Core Reference](https://github.com/dashpay/dash/blob/v0.15.0.0/src/privatesend/privatesend.h#L29))\n- This is the only message in the process that contains enough information to link a wallet's CoinJoin inputs with its outputs\n  - This message is sent directly between a client and the masternode processing the session (not relayed across the Dash network) so no other clients see it\n\n_**Step 6 - Final Transaction (unsigned)**_\n\n- Once the masternode has received valid [`dsi` messages](core-ref-p2p-network-privatesend-messages#dsi) from all clients, it creates the final transaction and sends a [`dsf` message](core-ref-p2p-network-privatesend-messages#dsf)\n  - Inputs/outputs are ordered deterministically as defined by [BIP-69](https://github.com/dashevo/bips/blob/master/bip-0069.mediawiki#Abstract) to avoid leaking any data ([Dash Core Reference](https://github.com/dashpay/dash/blob/v0.15.0.0/src/privatesend/privatesend-server.cpp#L271-L272))\n  - Clients must sign their inputs to the Final Transaction within 15 seconds or risk forfeiting the collateral they provided in the [`dsi` message](core-ref-p2p-network-privatesend-messages#dsi) (Step 4) ([Dash Core Reference](https://github.com/dashpay/dash/blob/v0.15.0.0/src/privatesend/privatesend.h#L24))\n\n_**Step 10 - Final Transaction broadcast**_\n\n- Prior to protocol version 70213, masternodes could only send a single un-mined [`dstx` message](core-ref-p2p-network-privatesend-messages#dstx) at a time. As of protocol version 70213, up to 5 (`MASTERNODE_MAX_MIXING_TXES`) un-mined [`dstx` messages](core-ref-p2p-network-privatesend-messages#dstx) per masternode are allowed. ([Dash Core Reference](https://github.com/dashpay/dash/blob/v0.15.0.0/src/masternode/masternode-meta.h#L16))\n\n_**General**_\n\n  With the exception of the [`dsq` message](core-ref-p2p-network-privatesend-messages#dsq) and the [`dstx` message](core-ref-p2p-network-privatesend-messages#dstx) (which need to be public and do not expose any private information), all CoinJoin P2P messages are sent directly between the masternode processing the transaction and the relevant client(s).\n\n# Fees\n\n**Processing Fees**\n\n- If processing completes successfully, Dash Core charges the collateral randomly in 1/10 denominate transactions to pay miners ([Dash Core Reference](https://github.com/dashpay/dash/blob/v0.17.0.0/src/coinjoin/coinjoin-server.cpp#L427-L444))\n- Clients that abuse the system by failing to respond to [`dsq` messages](core-ref-p2p-network-privatesend-messages#dsq) or [`dsf` messages](core-ref-p2p-network-privatesend-messages#dsf) within the timeout periods may forfeit their collateral. Dash Core charges the abuse fee in 1/3 cases ([Dash Core Reference](https://github.com/dashpay/dash/blob/v0.17.0.0/src/coinjoin/coinjoin-server.cpp#L357-L374))\n\n**Sending Fees**\n\nTo maintain privacy when using CoinJoin funds, transactions must fully spend all inputs to a single output (with the remainder becoming the fee - i.e. no <<glossary:change output>>). This can result in large fees depending on the value being sent.\n\nFor example, an extreme case is sending the minimum non-dust value (546 duffs). This results in an extremely large transaction fee because the minimum denomination (0.00100001 DASH or 100,001 duffs) must be fully spent with no change. This results in a fee of 0.00999464 DASH and a sent value of only 0.00000546 DASH as shown by the calculation below.\n\n100001 duffs (smallest CoinJoin denomination) - 546 duffs (value to send) = 99455 duffs (fee)",
 "mdxAltBody": "",
 "order": 3,
 "isReference": false,
 "deprecated": false,
 "hidden": false,
 "sync_unique": "",
 "link_url": "",
 "link_external": false,
 "reusableContent": [],
 "previousSlug": "",
 "slugUpdatedAt": "2020-08-11T19:36:04.022Z",
 "revision": 5,
 "_id": "63f5176df91c7700118e77c0",
 "version": "63f5176df91c7700118e7825",
 "updatedAt": "2023-04-25T20:01:05.142Z",
 "createdAt": "2019-10-23T19:41:11.479Z",
 "project": "5daf2e65f4109c0040fd51e1",
 "user": "5b8400d7185d5e00036dcc3b",
 "category": "63f5176df91c7700118e779e",
 "__v": 3,
 "parentDoc": "63f5176df91c7700118e77bd",
 "pendingAlgoliaPublish": false,
 "isApi": false,
 "id": "63f5176df91c7700118e77c0",
 "body_html": "<p>Dash Core&#x27;s mixing feature provides a way to improve privacy by performing non-custodial CoinJoin. For additional details, reference this <a href=\"https://docs.dash.org/en/stable/introduction/features.html#coinjoin\" target=\"\" title=\"\">Official Documentation page</a>.</p>\n<p>The following video provides an overview with a good introduction to the details:</p>\n<!-- -->\n<iframe href=\"https://www.youtube-nocookie.com/embed/vgCId3wJc5Y?rel=0\" height=\"350px\" width=\"100%\" border=\"none\" src=\"https://www.youtube-nocookie.com/embed/vgCId3wJc5Y?rel=0\" style=\"border:none;display:flex;margin:auto\"><a href=\"https://www.youtube-nocookie.com/embed/vgCId3wJc5Y?rel=0\" target=\"\" title=\"youtube-nocookie.com\">How Dash&#x27;s &#x27;PrivateSend&#x27; Works Under the Hood</a></iframe>\n<h1 class=\"heading heading-1 header-scroll\" align=\"\"><div class=\"heading-anchor anchor waypoint\" id=\"wallet-preparation\"></div><div class=\"heading-text\"><div id=\"section-wallet-preparation\" class=\"heading-anchor_backwardsCompatibility\"></div>Wallet Preparation</div><a aria-label=\"Skip link to Wallet Preparation\" class=\"heading-anchor-icon fa fa-anchor\" href=\"#wallet-preparation\"></a></h1>\n<p>The <span class=\"GlossaryItem-trigger\">wallet</span> completes two operations in this phase:</p>\n<ol>\n<li>\n<p>Split value into inputs matching the CoinJoin <span class=\"GlossaryItem-trigger\">denominations</span> by sending <span class=\"GlossaryItem-trigger\">transactions</span> to itself</p>\n</li>\n<li>\n<p>Split value into <span class=\"GlossaryItem-trigger\">inputs</span> to use for collateral by sending transactions to itself</p>\n</li>\n</ol>\n<p><strong>Note</strong>: Both these operations incur the standard <span class=\"GlossaryItem-trigger\">transaction fee</span> like any other transaction</p>\n<p><strong>Creating Denominations</strong></p>\n<p>The CoinJoin denominations include a bit mapping to easily differentiate them. The <a href=\"core-ref-p2p-network-privatesend-messages#dsa\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsa</code> message</a> and <a href=\"core-ref-p2p-network-privatesend-messages#dsq\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsq</code> message</a> use this bit shifted integer instead of sending the actual denomination. The table below lists the bit, its associated integer value used in P2P messages, and the actual Dash value.</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"rdmd-table\"><div class=\"rdmd-table-inner\"><table><thead><tr><th><strong>Bit</strong></th><th><strong>Denom. (Integer)</strong></th><th><strong>Denomination (DASH)</strong></th></tr></thead><tbody><tr><td>0</td><td>1</td><td>10.0001</td></tr><tr><td>1</td><td>2</td><td>01.00001</td></tr><tr><td>2</td><td>4</td><td>00.100001</td></tr><tr><td>3</td><td>8</td><td>00.0100001</td></tr><tr><td>4</td><td>16</td><td>00.00100001</td></tr></tbody></table></div></div>\n<p>Protocol version 70213 added a 5th denomination (0.001 DASH).</p>\n<p><a href=\"https://testnet-insight.dashevo.org/insight/tx/f0174fc87d68a18617c2990df4d9455c0459c601d2d6473934357a66f9b8b70a\" target=\"\" title=\"\">Example Testnet denomination creation transaction</a></p>\n<p><strong>Creating Collaterals</strong></p>\n<p>Collaterals are used to pay CoinJoin fees, but are kept separate from the denominations to maximize privacy. Since protocol version 70213, the minimum collateral fee is 1/10 of the smallest denomination for all sessions regardless of denomination. In Dash Core, collaterals are created with enough value to pay 4 collateral fees (4 x 0.001 DASH). (<a href=\"https://github.com/dashpay/dash/blob/v0.15.0.0/src/privatesend/privatesend.h#L459\" target=\"\" title=\"\">Dash Core Reference</a>)</p>\n<p>In protocol version 70208, collateral inputs can be anything from 2x the minimum collateral amount to the maximum collateral amount (currently defined as 4x the minimum collateral). In protocol versions &gt; 70208, Dash Core can use any <span class=\"GlossaryItem-trigger\">input</span> from 1x the minimum collateral amount to the maximum collateral amount.</p>\n<p><a href=\"https://testnet-insight.dashevo.org/insight/tx/8f9b15973983876f7ce4eb2c32b09690dfb0432d2caf6c6df516196a8d17689f\" target=\"\" title=\"\">Example Testnet collateral creation transaction</a></p>\n<p><a href=\"https://testnet-insight.dashevo.org/insight/tx/de51e6f7c5ef75aad0dbb0a808ef4873d7ef6d67b25f3a658d5a241db4f3eeeb\" target=\"\" title=\"\">Example Testnet collateral payment transaction</a></p>\n<h1 class=\"heading heading-1 header-scroll\" align=\"\"><div class=\"heading-anchor anchor waypoint\" id=\"coinjoin-processing\"></div><div class=\"heading-text\"><div id=\"section-coin-join-processing\" class=\"heading-anchor_backwardsCompatibility\"></div>CoinJoin Processing</div><a aria-label=\"Skip link to CoinJoin Processing\" class=\"heading-anchor-icon fa fa-anchor\" href=\"#coinjoin-processing\"></a></h1>\n<p>This phase involves exchanging a sequence of messages with a <span class=\"GlossaryItem-trigger\">masternode</span> so it can construct a denominate transaction with inputs from the clients in its pool.</p>\n<p><em>Data Flow</em></p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"rdmd-table\"><div class=\"rdmd-table-inner\"><table><thead><tr><th></th><th><strong>Clients</strong></th><th style=\"text-align:center\"><strong>Direction</strong></th><th><strong>Masternode</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td>0</td><td></td><td style=\"text-align:center\"></td><td></td><td>Client determines whether to join an existing pool or create a new one</td></tr><tr><td>1</td><td><a href=\"core-ref-p2p-network-privatesend-messages#dsa\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsa</code> message</a></td><td style=\"text-align:center\">\u2192</td><td></td><td>Client asks to join pool or have the masternode create a new one</td></tr><tr><td>2</td><td></td><td style=\"text-align:center\">\u2190</td><td><a href=\"core-ref-p2p-network-privatesend-messages#dssu\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dssu</code> message</a></td><td>Masternode provides a pool status update (Typical - State: <button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">POOL_STATE_QUEUE</code>, Message: <button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">MSG_NOERR</code>)</td></tr><tr><td>3</td><td></td><td style=\"text-align:center\">\u2190</td><td><a href=\"core-ref-p2p-network-privatesend-messages#dsq\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsq</code> message</a></td><td>Masternode notifies clients when it is ready to receive inputs</td></tr><tr><td>4</td><td><a href=\"core-ref-p2p-network-privatesend-messages#dsi\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsi</code> message</a></td><td style=\"text-align:center\">\u2192</td><td></td><td>Upon receiving a <a href=\"core-ref-p2p-network-privatesend-messages#dsq\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsq</code> message</a> with the Ready bit set, clients each provide a list of their inputs (unsigned), collateral, and a list of outputs where funds should be sent</td></tr><tr><td>5</td><td></td><td style=\"text-align:center\">\u2190</td><td><a href=\"core-ref-p2p-network-privatesend-messages#dssu\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dssu</code> message</a></td><td>Masternode provides a pool status update (typical - State: <button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">POOL_STATE_ACCEPTING_ENTRIES</code>, Message: <button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">MSG_ENTRIES_ADDED</code>)</td></tr><tr><td>6</td><td></td><td style=\"text-align:center\">\u2190</td><td><a href=\"core-ref-p2p-network-privatesend-messages#dsf\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsf</code> message</a></td><td>Masternode sends the final transaction containing all clients inputs (unsigned) and all client outputs to each client for verification</td></tr><tr><td>7</td><td></td><td style=\"text-align:center\">\u2190</td><td><a href=\"core-ref-p2p-network-privatesend-messages#dssu\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dssu</code> message</a></td><td>Masternode provides a pool status update (Typical - State: <button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">POOL_STATE_SIGNING</code>, Message: <button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">MSG_NOERR</code>)</td></tr><tr><td>8</td><td><a href=\"core-ref-p2p-network-privatesend-messages#dss\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dss</code> message</a></td><td style=\"text-align:center\">\u2192</td><td></td><td>After verifying the final transaction, clients each sign their own inputs and send them back</td></tr><tr><td>9</td><td></td><td style=\"text-align:center\">\u2190</td><td><a href=\"core-ref-p2p-network-privatesend-messages#dsc\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsc</code> message</a></td><td>Masternode verifies the signed inputs, creates a <a href=\"core-ref-p2p-network-privatesend-messages#dstx\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dstx</code> message</a> to broadcast the transaction, and notifies clients that the denominate transaction is complete (Typical - Message: <button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">MSG_SUCCESS</code>)</td></tr><tr><td>10</td><td></td><td style=\"text-align:center\">\u2190</td><td><a href=\"core-ref-p2p-network-data-messages#inv\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">inv</code> message</a></td><td>Masternode broadcasts a <button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dstx</code> inventory message</td></tr><tr><td>11</td><td><a href=\"core-ref-p2p-network-data-messages#getdata\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">getdata</code> message</a> (dstx)</td><td style=\"text-align:center\">\u2192</td><td></td><td>(Optional)</td></tr></tbody></table></div></div>\n<p><strong>Additional notes</strong></p>\n<p><em><strong>Step 0 - Pool Selection</strong></em></p>\n<ul>\n<li>Existing pool information is derived from the Queue messages seen by the client</li>\n<li>Dash Core attempts to join an existing pool and only requests creation of a new one if that fails, although this is not a requirement that alternative implementations would be required to follow</li>\n</ul>\n<p><em><strong>Step 1 - Pool Request</strong></em></p>\n<ul>\n<li>The <a href=\"core-ref-p2p-network-privatesend-messages#dsa\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsa</code> message</a> contains a collateral transaction\n<ul>\n<li>This transaction uses a collateral <span class=\"GlossaryItem-trigger\">input</span> created in the <a href=\"#wallet-preparation\" target=\"\" title=\"\">Wallet Preparation</a> phase</li>\n<li>The collateral is a signed <span class=\"GlossaryItem-trigger\">transaction</span> that pays the collateral back to a client <span class=\"GlossaryItem-trigger\">address</span> minus a fee of 0.001 DASH</li>\n</ul>\n</li>\n</ul>\n<p><em><strong>Step 3 - Queue</strong></em></p>\n<ul>\n<li>A masternode broadcasts <a href=\"core-ref-p2p-network-privatesend-messages#dsq\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsq</code> messages</a> when it starts a new queue. These message are relayed by all <span class=\"GlossaryItem-trigger\">peers</span>.</li>\n<li>As of protocol version 70214, sessions have a variable number of participants defined by the range <button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">nPoolMinParticipants</code> (<a href=\"https://github.com/dashpay/dash/blob/v0.15.0.0/src/chainparams.cpp#L360\" target=\"\" title=\"\">3</a>) to <button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">nPoolMaxParticipants</code> (<a href=\"https://github.com/dashpay/dash/blob/v0.15.0.0/src/chainparams.cpp#L361\" target=\"\" title=\"\">5</a>). Prior protocol version sessions always contained exactly 3 participants. Spork 22 introduced in Dash Core 0.16.0 expanded the maximum number of participants to 20 and also reduced the minimum number of participants to 2 for testnet/devnet/regtest networks. The spork was removed in Dash Core 0.17.0 which made the change permanent.</li>\n<li>The masternode sends a <a href=\"core-ref-p2p-network-privatesend-messages#dsq\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsq</code> message</a> with the ready bit set once it has received valid <a href=\"core-ref-p2p-network-privatesend-messages#dsa\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsa</code> messages</a> from either:\n<ol>\n<li>The maximum number of clients (20)</li>\n<li>Greater than the minimum number of clients (3) and the timeout has been reached (<a href=\"https://github.com/dashpay/dash/blob/v0.16.x/src/privatesend/privatesend.h#L23\" target=\"\" title=\"\">30 seconds</a>)</li>\n</ol>\n</li>\n</ul>\n<blockquote class=\"callout callout_warn\" theme=\"\ud83d\udea7\"><h2 class=\"callout-heading empty\"><span class=\"callout-icon\">\ud83d\udea7</span></h2><p>Clients must respond to the Queue ready within 30 seconds or risk forfeiting the collateral they provided in the <a href=\"core-ref-p2p-network-privatesend-messages#dsa\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsa</code> message</a> (Step 1) (<a href=\"https://github.com/dashpay/dash/blob/v0.16.x/src/privatesend/privatesend.h#L23\" target=\"\" title=\"\">Dash Core Reference</a>)</p></blockquote>\n<p><em><strong>Step 4 - Inputs</strong></em></p>\n<ul>\n<li>The collateral transaction can be the same in the <a href=\"core-ref-p2p-network-privatesend-messages#dsi\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsi</code> message</a> as the one in the <a href=\"core-ref-p2p-network-privatesend-messages#dsa\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsa</code> message</a> (Step 1) as long as it has not been spent</li>\n<li>Each client can provide up to 9 (<button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">COINJOIN_ENTRY_MAX_SIZE</code>) inputs (and an equal number of outputs) to be used (<a href=\"https://github.com/dashpay/dash/blob/v0.15.0.0/src/privatesend/privatesend.h#L29\" target=\"\" title=\"\">Dash Core Reference</a>)</li>\n<li>This is the only message in the process that contains enough information to link a wallet&#x27;s CoinJoin inputs with its outputs\n<ul>\n<li>This message is sent directly between a client and the masternode processing the session (not relayed across the Dash network) so no other clients see it</li>\n</ul>\n</li>\n</ul>\n<p><em><strong>Step 6 - Final Transaction (unsigned)</strong></em></p>\n<ul>\n<li>Once the masternode has received valid <a href=\"core-ref-p2p-network-privatesend-messages#dsi\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsi</code> messages</a> from all clients, it creates the final transaction and sends a <a href=\"core-ref-p2p-network-privatesend-messages#dsf\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsf</code> message</a>\n<ul>\n<li>Inputs/outputs are ordered deterministically as defined by <a href=\"https://github.com/dashevo/bips/blob/master/bip-0069.mediawiki#Abstract\" target=\"\" title=\"\">BIP-69</a> to avoid leaking any data (<a href=\"https://github.com/dashpay/dash/blob/v0.15.0.0/src/privatesend/privatesend-server.cpp#L271-L272\" target=\"\" title=\"\">Dash Core Reference</a>)</li>\n<li>Clients must sign their inputs to the Final Transaction within 15 seconds or risk forfeiting the collateral they provided in the <a href=\"core-ref-p2p-network-privatesend-messages#dsi\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsi</code> message</a> (Step 4) (<a href=\"https://github.com/dashpay/dash/blob/v0.15.0.0/src/privatesend/privatesend.h#L24\" target=\"\" title=\"\">Dash Core Reference</a>)</li>\n</ul>\n</li>\n</ul>\n<p><em><strong>Step 10 - Final Transaction broadcast</strong></em></p>\n<ul>\n<li>Prior to protocol version 70213, masternodes could only send a single un-mined <a href=\"core-ref-p2p-network-privatesend-messages#dstx\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dstx</code> message</a> at a time. As of protocol version 70213, up to 5 (<button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">MASTERNODE_MAX_MIXING_TXES</code>) un-mined <a href=\"core-ref-p2p-network-privatesend-messages#dstx\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dstx</code> messages</a> per masternode are allowed. (<a href=\"https://github.com/dashpay/dash/blob/v0.15.0.0/src/masternode/masternode-meta.h#L16\" target=\"\" title=\"\">Dash Core Reference</a>)</li>\n</ul>\n<p><em><strong>General</strong></em></p>\n<p>  With the exception of the <a href=\"core-ref-p2p-network-privatesend-messages#dsq\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsq</code> message</a> and the <a href=\"core-ref-p2p-network-privatesend-messages#dstx\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dstx</code> message</a> (which need to be public and do not expose any private information), all CoinJoin P2P messages are sent directly between the masternode processing the transaction and the relevant client(s).</p>\n<h1 class=\"heading heading-1 header-scroll\" align=\"\"><div class=\"heading-anchor anchor waypoint\" id=\"fees\"></div><div class=\"heading-text\"><div id=\"section-fees\" class=\"heading-anchor_backwardsCompatibility\"></div>Fees</div><a aria-label=\"Skip link to Fees\" class=\"heading-anchor-icon fa fa-anchor\" href=\"#fees\"></a></h1>\n<p><strong>Processing Fees</strong></p>\n<ul>\n<li>If processing completes successfully, Dash Core charges the collateral randomly in 1/10 denominate transactions to pay miners (<a href=\"https://github.com/dashpay/dash/blob/v0.17.0.0/src/coinjoin/coinjoin-server.cpp#L427-L444\" target=\"\" title=\"\">Dash Core Reference</a>)</li>\n<li>Clients that abuse the system by failing to respond to <a href=\"core-ref-p2p-network-privatesend-messages#dsq\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsq</code> messages</a> or <a href=\"core-ref-p2p-network-privatesend-messages#dsf\" target=\"\" title=\"\"><button aria-label=\"Copy Code\" class=\"rdmd-code-copy fa\"></button><code class=\"rdmd-code lang- theme-light\" data-lang=\"\" name=\"\" tabindex=\"0\">dsf</code> messages</a> within the timeout periods may forfeit their collateral. Dash Core charges the abuse fee in 1/3 cases (<a href=\"https://github.com/dashpay/dash/blob/v0.17.0.0/src/coinjoin/coinjoin-server.cpp#L357-L374\" target=\"\" title=\"\">Dash Core Reference</a>)</li>\n</ul>\n<p><strong>Sending Fees</strong></p>\n<p>To maintain privacy when using CoinJoin funds, transactions must fully spend all inputs to a single output (with the remainder becoming the fee - i.e. no <span class=\"GlossaryItem-trigger\">change output</span>). This can result in large fees depending on the value being sent.</p>\n<p>For example, an extreme case is sending the minimum non-dust value (546 duffs). This results in an extremely large transaction fee because the minimum denomination (0.00100001 DASH or 100,001 duffs) must be fully spent with no change. This results in a fee of 0.00999464 DASH and a sent value of only 0.00000546 DASH as shown by the calculation below.</p>\n<p>100001 duffs (smallest CoinJoin denomination) - 546 duffs (value to send) = 99455 duffs (fee)</p>"
}